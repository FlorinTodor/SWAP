FROM ubuntu:latest

# Actualizamos los paquetes del sistema

RUN  apt-get update && apt-get upgrade -y



# Creamos el directorio de trabajo 
RUN mkdir -p /var/log/apache2
RUN chown -R www-data:www-data /var/log/apache2

# Instalamos apache2 y php

RUN apt-get install apache2 php libapache2-mod-php -y
RUN apt-get install iptables -y 



# Elimina el warning del ServerName
RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf
# Instalamos las herramientas de internet b치sicas (net-tools)

RUN  apt install net-tools -y
RUN  apt install iputils-ping -y

# Cambiamos la configuraci칩n de apache para poner mayor seguridad
COPY ./P4-flotodor-apache/apache_config/.htaccess /var/www/html/.htaccess

# Copiamos el script de IPTables
COPY ./P4-flotodor-apache/P4-flotodor-iptables-web/flotodor-iptables-web.sh /usr/local/bin/iptables.sh
RUN chmod +x /usr/local/bin/iptables.sh

# Copiar el script de monitoreo 
COPY ./P4-flotodor-apache/apache_monitor.sh /usr/local/bin/apache_monitor.sh
RUN chmod +x /usr/local/bin/apache_monitor.sh

### EJecuci칩n de servicios de la imagen

COPY ./P4-flotodor-apache/entrypoint_apache.sh /usr/local/bin/entrypoint_apache.sh
RUN chmod +x /usr/local/bin/entrypoint_apache.sh
RUN echo 'DirectoryIndex index.php index.html' >> /etc/apache2/apache2.conf

#prometheus
# Al final del Dockerfile
RUN apt update && apt install -y wget \
 && wget https://github.com/prometheus/node_exporter/releases/download/v1.8.1/node_exporter-1.8.1.linux-amd64.tar.gz \
 && tar xzf node_exporter-*.tar.gz \
 && mv node_exporter-*/node_exporter /usr/local/bin/ \
 && rm -rf node_exporter*

 
# ----------------------------------------------
# Parte SSL: certificados + configuraci칩n SSL
# ----------------------------------------------

    RUN mkdir -p /etc/apache2/ssl/
    COPY P4-flotodor-certificados/certificado_flotodor.crt /etc/apache2/ssl/certificado_flotodor.crt
    COPY P4-flotodor-certificados/certificado_flotodor.key /etc/apache2/ssl/certificado_flotodor.key
    
    RUN chmod 600 /etc/apache2/ssl/certificado_flotodor.crt
    COPY P4-flotodor-apache/flotodor-apache-ssl.conf /etc/apache2/sites-available/flotodor-apache-ssl.conf
    RUN a2enmod ssl && a2dissite default-ssl && a2ensite flotodor-apache-ssl
    
    
    EXPOSE 80 443 9100
    ENTRYPOINT ["/usr/local/bin/entrypoint_apache.sh"]