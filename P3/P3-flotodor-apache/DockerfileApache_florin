FROM ubuntu:latest

# Actualizamos los paquetes del sistema

RUN  apt-get update && apt-get upgrade -y



# Creamos el directorio de trabajo 
RUN mkdir -p /var/log/apache2
RUN chown -R www-data:www-data /var/log/apache2

# Instalamos apache2 y php

RUN apt-get install apache2 php libapache2-mod-php -y



# Elimina el warning del ServerName
RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf
# Instalamos las herramientas de internet básicas (net-tools)

RUN  apt install net-tools -y
RUN  apt install iputils-ping -y

# Cambiamos la configuración de apache para poner mayor seguridad
COPY ./P3-flotodor-apache/apache_config/.htaccess /var/www/html/.htaccess

# Copiar el script de monitoreo
COPY ./P3-flotodor-apache/apache_monitor.sh /usr/local/bin/apache_monitor.sh
RUN chmod +x /usr/local/bin/apache_monitor.sh

### EJecución de servicios de la imagen

COPY ./P3-flotodor-apache/entrypoint_apache.sh /usr/local/bin/entrypoint_apache.sh
RUN chmod +x /usr/local/bin/entrypoint_apache.sh
RUN echo 'DirectoryIndex index.php index.html' >> /etc/apache2/apache2.conf

#prometheus
# Al final del Dockerfile
RUN apt update && apt install -y wget \
 && wget https://github.com/prometheus/node_exporter/releases/download/v1.8.1/node_exporter-1.8.1.linux-amd64.tar.gz \
 && tar xzf node_exporter-*.tar.gz \
 && mv node_exporter-*/node_exporter /usr/local/bin/ \
 && rm -rf node_exporter*

 # ------- Copiamos los ficheros que necesitaremos en el directorio tmp -------
COPY P3-flotodor-certificados/certificado_flotodor.crt /tmp/
COPY P3-flotodor-certificados/certificado_flotodor.key /tmp/
COPY P3-flotodor-apache/flotodor-apache-ssl.conf       /tmp/
# ------------------------------------------------------


# --- SSL ------------------------------------------------------------------
    RUN apt-get update && apt-get install -y openssl \
    && a2enmod ssl headers rewrite \
    && mkdir -p /etc/apache2/ssl \
    \
    # Copiamos certificado y clave
    && cp /tmp/certificado_flotodor.crt /etc/apache2/ssl/ \
    && cp /tmp/certificado_flotodor.key /etc/apache2/ssl/ \
    && chmod 600 /etc/apache2/ssl/certificado_flotodor.key \
    && chmod 644 /etc/apache2/ssl/certificado_flotodor.crt \
    \
    # Deshabilitamos los vhosts por defecto
    && a2dissite 000-default.conf default-ssl.conf \
    \
    # Copiamos y habilitamos nuestro vhost HTTPS
    && cp /tmp/flotodor-apache-ssl.conf /etc/apache2/sites-available/ \
    && a2ensite flotodor-apache-ssl.conf
   # --------------------------------------------------------------------------




ENTRYPOINT ["/usr/local/bin/entrypoint_apache.sh"]
#CMD [ "apache2ctl", "-D", "FOREGROUND" ] # solo ejecutar apache 


# Exponemos el puerto 80 para HTTP y 443 para HTTPS , 9100 para el node exporter
EXPOSE 80
EXPOSE 9100
EXPOSE 443

